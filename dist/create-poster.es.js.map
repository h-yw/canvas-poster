{"version":3,"file":"create-poster.es.js","sources":["../lib/index.ts"],"sourcesContent":["/**\r\n * @name CanvasPoster\r\n * @desc canvas poster，easy to create poster and export picture\r\n * @desc 创建canvas海报,便于快速生成海报并导出图片\r\n * @author Mr.Hou\r\n * @time 2021/11/18\r\n */\r\nimport { PosterConfig, TextConfig, ImageConfig } from \"./type\";\r\nclass CanvasPoster {\r\n  private _canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n  private _config: PosterConfig;\r\n  constructor(canvas: HTMLCanvasElement, config: PosterConfig | undefined) {\r\n    this._canvas = canvas;\r\n    this._config = config;\r\n    this._ctx = this._canvas.getContext(\"2d\");\r\n    // 设置canvas\r\n    this._setCanvas();\r\n  }\r\n  /**\r\n   * @description 设置canvas参数\r\n   * @return\r\n   */\r\n  private _setCanvas(): void {\r\n    if (this._config) {\r\n      this._canvas.width = this._config.width;\r\n      this._canvas.height = this._config.height;\r\n    }\r\n    this._ctx.font = \"24px sans-serif\";\r\n    this._ctx.fillStyle = \"#000\";\r\n    this._ctx.textAlign = \"center\";\r\n    this._ctx.textBaseline = \"middle\";\r\n  }\r\n\r\n  /**\r\n   * @description 绘制\r\n   * @param {Array[ImageConfig|TextConfig]} data\r\n   * @returns\r\n   */\r\n  public async draw(data: Array<any>): Promise<void> {\r\n    let len = data.length;\r\n    for (let i = 0; i < len; i++) {\r\n      if (data[i].type === \"text\") {\r\n        this.drawText(data[i]);\r\n        console.log(i);\r\n\r\n        // continue\r\n      }\r\n      if (data[i].type === \"image\") {\r\n        if (data[i].image instanceof Image) {\r\n          this.drawImage(data[i]);\r\n          console.log(i);\r\n\r\n          // continue\r\n        }\r\n        if (typeof data[i].image === \"string\") {\r\n          let img = await this.createImage(data[i].image);\r\n          data[i].image = img;\r\n          // console.log(res);\r\n          this.drawImage(data[i]);\r\n          console.log(i);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @description 绘制文字\r\n   * @param {TextConfig} params\r\n   * @returns\r\n   */\r\n  public async drawText(params: TextConfig): Promise<number> {\r\n    return new Promise((resolve, reject) => {\r\n      if (params.font) {\r\n        this._ctx.font = params.font;\r\n      }\r\n      if (params.color) {\r\n        this._ctx.fillStyle = params.color;\r\n      }\r\n      if (params.textAlign) {\r\n        this._ctx.textAlign = params.textAlign;\r\n      }\r\n      if (!params.maxWidth) {\r\n        this._ctx.fillText(params.text, params.x, params.y);\r\n        return;\r\n      }\r\n      let MAX_WIDTH = params.maxWidth || 200;\r\n      let totalLine = params.totalLine || 1;\r\n      let lineHeight = params.lineHeight || 24;\r\n      let startX = params.x || 0;\r\n      let startY = params.y || 0;\r\n      let allAtr = params.text.split(\"\");\r\n      let rowArr = []; // 拆分出来的每一行\r\n      let rowStrArr = []; // 每一行的文字数组\r\n      for (let i = 0; i < allAtr.length; i++) {\r\n        const currentStr = allAtr[i];\r\n        rowStrArr.push(currentStr);\r\n        const rowStr = rowStrArr.join(\"\");\r\n        if (this._ctx.measureText(rowStr).width > MAX_WIDTH) {\r\n          rowStrArr.pop(); // 删除最后一个\r\n          rowArr.push(rowStrArr.join(\"\")); // 完成一行\r\n          rowStrArr = [currentStr];\r\n          continue;\r\n        }\r\n        // 最后一个字母 直接添加到一行\r\n        if (i === allAtr.length - 1) {\r\n          rowArr.push(rowStr); // 完成一行\r\n        }\r\n      }\r\n      let line = rowArr.length > totalLine ? totalLine : rowArr.length;\r\n      for (let i = 0; i < line; i++) {\r\n        // console.log(rowArr[i], i, line);\r\n        if (i + 1 === line && line !== 1) {\r\n          rowArr[i] = rowArr[i] + \"...\";\r\n        }\r\n        this._ctx.fillText(rowArr[i], startX, startY + i * lineHeight);\r\n      }\r\n      resolve(rowArr.length);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @description 绘制图片\r\n   * @param {ImageConfig} params\r\n   * @returns\r\n   */\r\n  public async drawImage(params: ImageConfig): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      if (params.borderRadius !== undefined) {\r\n        this.creatBorderRect(\r\n          params.x,\r\n          params.y,\r\n          params.width,\r\n          params.height,\r\n          params.borderRadius,\r\n        );\r\n        // this.restore()\r\n      }\r\n      // console.log('drawImage: params', params);\r\n\r\n      if (\r\n        params.dx == undefined ||\r\n        params.dy == undefined ||\r\n        params.dWidth == undefined ||\r\n        params.dHeight == undefined\r\n      ) {\r\n        this._ctx.drawImage(\r\n          params.image,\r\n          params.x,\r\n          params.y,\r\n          params.width,\r\n          params.height,\r\n        );\r\n      } else {\r\n        this._ctx.drawImage(\r\n          params.image,\r\n          params.dx,\r\n          params.dy,\r\n          params.dWidth,\r\n          params.dHeight,\r\n          params.x,\r\n          params.y,\r\n          params.width,\r\n          params.height,\r\n        );\r\n      }\r\n      this.restore();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @description 创建图片\r\n   * @param {string} url\r\n   * @returns {Promise<HTMLImageElement|unknown>}\r\n   */\r\n  public createImage(src: string): Promise<HTMLImageElement | unknown> {\r\n    if (!Image) {\r\n      console.log(\"不支持new Image(),传入CanvasImageSource\");\r\n      return;\r\n    }\r\n    let img = new Image();\r\n    img.src = src;\r\n    img.referrerPolicy = \"no-referrer\";\r\n    let imgPo = new Promise((resolve, reject) => {\r\n      img.onload = function () {\r\n        resolve(img);\r\n      };\r\n      img.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n    return imgPo;\r\n  }\r\n\r\n  /**\r\n   * @description 创建圆角矩形\r\n   * @param {number} x x坐标\r\n   * @param {number} y y坐标\r\n   * @param {number} width 宽度\r\n   * @param {number} height 高度\r\n   * @param {number} radius 圆角半径\r\n   * @returns\r\n   */\r\n  public creatBorderRect(\r\n    x: number,\r\n    y: number,\r\n    w: any,\r\n    h: any,\r\n    r: number,\r\n    color?: string | CanvasGradient | CanvasPattern,\r\n  ) {\r\n    this._ctx.beginPath();\r\n    // 左上角\r\n    this._ctx.arc(x + r, y + r, r, Math.PI, 1.5 * Math.PI);\r\n    this._ctx.moveTo(x + r, y);\r\n    this._ctx.lineTo(x + w - r, y);\r\n    this._ctx.lineTo(x + w, y + r);\r\n    // 右上角\r\n    this._ctx.arc(x + w - r, y + r, r, 1.5 * Math.PI, 2 * Math.PI);\r\n    this._ctx.lineTo(x + w, y + h - r);\r\n    this._ctx.lineTo(x + w - r, y + h);\r\n    // 右下角\r\n    this._ctx.arc(x + w - r, y + h - r, r, 0, 0.5 * Math.PI);\r\n    this._ctx.lineTo(x + r, y + h);\r\n    this._ctx.lineTo(x, y + h - r);\r\n    // 左下角\r\n    this._ctx.arc(x + r, y + h - r, r, 0.5 * Math.PI, Math.PI);\r\n    this._ctx.lineTo(x, y + r);\r\n    this._ctx.lineTo(x + r, y);\r\n\r\n    this._ctx.fillStyle = color || \"#5a5a5a\";\r\n    this._ctx.fill();\r\n    this._ctx.closePath();\r\n    this._ctx.save();\r\n    this._ctx.clip();\r\n  }\r\n\r\n  /**\r\n   * @description 恢复clip区域限制\r\n   * @returns\r\n   */\r\n  public restore() {\r\n    this._ctx.restore();\r\n  }\r\n  /**\r\n   *\r\n   * @param type 图片类型\r\n   * @param quality 图片质量(0-1)\r\n   * @returns String\r\n   */\r\n  public canvas2Image(type: string, quality: number) {\r\n    let canvasImg = this._canvas.toDataURL(\"image/png\", 1);\r\n    return canvasImg;\r\n  }\r\n\r\n  /**\r\n   * @description 获取canvas\r\n   * @returns {HTMLCanvasElement}\r\n   */\r\n  public getCanvas(): HTMLCanvasElement {\r\n    return this._canvas;\r\n  }\r\n  /**\r\n   * @description 获取canvas的上下文\r\n   * @returns {RenderingContext}\r\n   */\r\n  public getCtx(): RenderingContext {\r\n    return this._ctx;\r\n  }\r\n}\r\n\r\nexport default CanvasPoster;\r\n"],"names":[],"mappings":"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"}